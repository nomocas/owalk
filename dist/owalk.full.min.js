!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.owalk=f()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){require("../lib/descriptor"),require("../lib/rql"),module.exports=require("../lib/finder")},{"../lib/descriptor":3,"../lib/finder":4,"../lib/rql":5}],2:[function(require,module,exports){module.exports={print:function(node){node?node.__owalk_node__||node.__owalk_array__?node.forEach?node.forEach(function(n){n&&console.log("> node : %s : ",n.path,n.value)}):console.log("node : %s : ",node.path,node.value):console.log("pure property : ",node):console.log("node is null")}}},{}],3:[function(require,module,exports){var owalk=require("../index"),Descriptor=function(parent,key){var path;if(parent){if(this.parent=parent,path=parent.path,path+=parent.key?"/"+key:key,parent.schema){if(!owalk.getSchemaByPath)throw new Error("no method 'getSchemaByPath' founded in owalk. could not use schema in it.");this.schema=owalk.getSchemaByPath(parent.schema,key,"/")}this.value=parent.value[key],this.depth=parent.depth+1,this.root=parent.root||parent}this.__owalk_node__=!0,this.path=path,this.key=key};Descriptor.prototype={set:function(value){return this.value=value,this.parent&&(this.parent.value[this.key]=value),value},clone:function(){return this.parent?new Descriptor(this.parent,this.key):Descriptor.root(this.value,this.schema)}},Descriptor.root=function(obj,schema){obj&&obj._deep_undefined_&&(obj=void 0);var node=new Descriptor;return node.value=obj,node.path="/",node.schema=schema,node.depth=0,node},owalk.Descriptor=Descriptor,module.exports=owalk},{"../index":2}],4:[function(require,module,exports){function parseStep(selector){switch(selector[0]){case"?":return{value:selector,type:"rql"};case"(":return{value:new RegExp(selector),type:"regex"};case".":return{value:selector,type:"move"};case"[":return{value:selector.substring(1,selector.length-1).split(",").map(parseStep),type:"union"};default:return{value:selector,type:"sel"}}}function parse(q){if(queryCache[q])return queryCache[q];for(var match=null,tokens=[];match=step.exec(q);)"//"===match[1]&&tokens.push({type:"recursion"}),tokens.push(parseStep(match[3]?match[3]:match[2]));return queryCache[q]=tokens,tokens}function select(obj,key,desc){if(obj.forEach){for(var output=[],i=0,len=obj.length;len>i;++i){var o=obj[i],v=desc?o.value:o;v[key]&&output.push(desc?new owalk.Descriptor(obj[i],key):v[key])}return output}var v=desc?obj.value:obj;return v[key]?desc?new owalk.Descriptor(obj,key):v[key]:void 0}function selectRegExp(obj,regex,desc){var i,j,o,output=[],v=desc?obj.value:obj;if(obj.forEach)for(i=0,len=obj.length;i<len;++i){o=obj[i],v=desc?o.value:o;for(j in v)regex.test(j)&&output.push(desc?new owalk.Descriptor(o,j):v[j])}else for(j in v)regex.test(j)&&output.push(desc?new owalk.Descriptor(obj,j):v[j]);return output}function selectRQL(obj,rqlQuery,desc){if(!owalk.rql)throw new Error("no rql-array module has been linked to owalk : you could not use rql in your query");if(obj.forEach)return owalk.rql(obj,rqlQuery);var res=owalk.rql([obj],rqlQuery);return res?res[0]:void 0}function selectChildren(obj,recursive,desc){var i,j,o,output=[],v=desc?obj.value:obj;if(obj.forEach){for(i=0,len=obj.length;i<len;++i)if(o=obj[i],v=desc?o.value:o,"object"==typeof v)for(j in v){var child=desc?new owalk.Descriptor(o,j):v[j],cv=desc?child.value:child;output.push(child),recursive&&cv&&"object"==typeof cv&&(output=output.concat(selectChildren(child,!0,desc)))}}else if("object"==typeof v)for(j in v){var child=desc?new owalk.Descriptor(obj,j):v[j],cv=desc?child.value:child;output.push(child),recursive&&cv&&"object"==typeof cv&&(output=output.concat(selectChildren(child,!0,desc)))}return output}function selectParent(obj,desc){if(desc){var cacheCheck={};if(obj.forEach){var i,output=[];for(i=0,len=obj.length;i<len;++i){var o=obj[i];cacheCheck[o.parent.path]||(output.push(o.parent),cacheCheck[o.parent.path]=!0)}return output}return obj.parent}}function applyStep(obj,step,desc){switch(step.type){case"rql":return selectRQL(obj,step.value,desc);case"move":switch(step.value){case".":return obj;case"..":return selectParent(obj,desc);default:throw new Error("dpath : bad move parsing")}break;case"recursion":return selectChildren(obj,!0,desc);case"sel":switch(step.value){case"":return obj;case"*":return selectChildren(obj,!1,desc);default:return select(obj,step.value,desc)}break;case"union":for(var output,res=[],i=0,len=step.value.length;len>i;++i)output=applyStep(obj,step.value[i],desc),"undefined"!=typeof output&&(res=res.concat(output));return res;case"regex":return selectRegExp(obj,step.value,desc);default:throw new Error("desc.find : step type unrecognised : "+step.type)}}function find(q,obj,desc){if(obj){if(desc&&!owalk.Descriptor)throw new Error("owalk descriptor module has not been loaded. You could not ask owalk Descriptor response.");var tokens=parse(q),tmp=desc?obj.__owalk_node__?obj:owalk.Descriptor.root(obj):obj;desc&&tokens[0]&&"move"==!tokens[0].type&&(obj=obj.root||obj);for(var i=0,len=tokens.length;tmp&&len>i;++i)if(tmp=applyStep(tmp,tokens[i],desc),tmp&&tmp.forEach&&!tmp.length)return;return desc&&tmp&&tmp.forEach&&(tmp.__owalk_array__=!0),tmp}}var owalk=require("../index"),step=/(?:(\/\/?)([^\/]*))|(\.\.?)/g,queryCache={};owalk.find=find,owalk.parseQuery=parse,module.exports=owalk},{"../index":2}],5:[function(require,module,exports){"use strict";function getJSPrimitiveType(obj){return obj&&obj.forEach?"array":typeof obj}function inArray(inArr,what){if(!inArr||!inArr.forEach)return!1;if(what.forEach){var test={};inArr.forEach(function(e){test[e]=!0});var okCount=0;return what.forEach(function(e){test[e]&&okCount++}),okCount==what.length?!0:!1}return inArr.some(function(e){return what===e})}function rqlNodeToFunc(node){if("object"==typeof node){var name=node.name,args=node.args;if(node.forEach)return node.map(rqlNodeToFunc);var b=args[0],path=null;2==args.length&&(path=b,b=args[1]);var func=null,isFilter=!1;switch(name){case"eq":isFilter=!0,func=function(a){return(retrieve(a,path)||void 0)===b};break;case"ne":isFilter=!0,func=function(a){return(retrieve(a,path)||void 0)!==b};break;case"le":isFilter=!0,func=function(a){return(retrieve(a,path)||void 0)<=b};break;case"ge":isFilter=!0,func=function(a){return(retrieve(a,path)||void 0)>=b};break;case"lt":isFilter=!0,func=function(a){return(retrieve(a,path)||void 0)<b};break;case"gt":isFilter=!0,func=function(a){return(retrieve(a,path)||void 0)>b};break;default:var ops=rql.ops[name];if(!ops)throw new Error("RQLError : no operator found in rql with : "+name);args&&args.length>0?(args=args.map(rqlNodeToFunc),func=function(){return ops.apply(this,args)}):func=function(){return ops.call(this)}}return isFilter?function(){var r=this.filter(func);return r}:func}return node}function retrieve(obj,path){if(!path)return obj.__owalk_node__?obj.value:obj;var splitted=path.split("."),tmp=obj;switch(splitted[0]){case"_schema":if(!obj.__owalk_node__)return void 0;splitted.shift(),tmp=obj.schema;break;case"_depth":return obj.__owalk_node__?obj.depth:void 0;case"_type":return getJSPrimitiveType(obj.__owalk_node__?obj.value:obj);default:obj.__owalk_node__&&(tmp=tmp.value)}if(!tmp)return tmp;var len=splitted.length,needtype=!1;if("_type"==splitted[len-1]&&(len--,needtype=!0,splitted.pop()),5>len){var res;switch(len){case 1:res=tmp[splitted[0]];break;case 2:res=tmp[splitted[0]]&&tmp[splitted[0]][splitted[1]];break;case 3:res=tmp[splitted[0]]&&tmp[splitted[0]][splitted[1]]&&tmp[splitted[0]][splitted[1]][splitted[2]];break;case 4:res=tmp[splitted[0]]&&tmp[splitted[0]][splitted[1]]&&tmp[splitted[0]][splitted[1]][splitted[2]]&&tmp[splitted[0]][splitted[1]][splitted[2]][splitted[3]]}return"undefined"!=typeof res&&needtype?getJSPrimitiveType(res):res}if(tmp=tmp[splitted[0]]&&tmp[splitted[0]][splitted[1]]&&tmp[splitted[0]][splitted[1]][splitted[2]]&&tmp[splitted[0]][splitted[1]][splitted[2]][splitted[3]],"undefined"==typeof tmp)return void 0;for(var count=4,part=splitted[count];part&&tmp[part];)tmp=tmp[part],part=splitted[++count];return count===len?needtype?getJSPrimitiveType(tmp):tmp:void 0}function filter(condition,not){var filtr=function(property,second){"undefined"==typeof second&&(second=property,property=void 0);for(var filtered=(arguments,[]),i=0,length=this.length;length>i;i++){var item=this[i];condition(evaluateProperty(item,property),second)&&filtered.push(item)}return filtered};return filtr.condition=condition,filtr}function reducer(func){return function(property){return property?this.map(function(object){return retrieve(object,property)}).reduce(func):this.reduce(func)}}function evaluateProperty(object,property){return property&&property.forEach?retrieve(object,decodeURIComponent(property)):"undefined"==typeof property?retrieve(object):retrieve(object,decodeURIComponent(property))}var parser=require("rql/parser"),owalk=require("../index"),rqlParser=parser.parseQuery,queryCache={},rql=function(array,query){return"?"==query[0]&&(query=query.substring(1)),queryCache[query]?queryCache[query].call(array):rql.compile(query).call(array)};rql.parse=function(input){try{var r=rqlParser(input);return r.toString=function(){return input},r}catch(e){return null}},rql.compile=function(query){var parsed=rql.parse(query),func=rqlNodeToFunc(parsed);return queryCache[query]=func,func},rql.ops={isPresent:function(path,items){for(var res=[],len=items.length,i=0;len>i;++i)retrieve(items[i],path)&&res.push(items[i]);return res},sort:function(){for(var terms=[],i=0;i<arguments.length;i++){var sortAttribute=arguments[i],firstChar=sortAttribute.charAt(0),term={attribute:sortAttribute,ascending:!0};("-"==firstChar||"+"==firstChar)&&("-"==firstChar&&(term.ascending=!1),term.attribute=term.attribute.substring(1)),terms.push(term)}return this.sort(function(a,b){for(var term,i=0;term=terms[i];i++){var ar=retrieve(a,term.attribute),br=retrieve(b,term.attribute);if(ar!=br)return term.ascending==ar>br?1:-1}return 0}),this},match:filter(function(value,regex){return new RegExp(regex).test(value)}),"in":filter(function(value,values){for(var ok=!1,count=0;!ok&&count<values.length;)values[count++]==value&&(ok=!0);return ok}),out:filter(function(value,values){for(var ok=!0,count=0;ok&&count<values.length;)values[count++]==value&&(ok=!1);return ok}),contains:filter(inArray),excludes:filter(function(array,value){return!inArray(array,value)}),or:function(){for(var items=[],i=0;i<arguments.length;++i){var a=arguments[i];items="function"==typeof a?items.concat(a.call(this)):items.concat(rql.ops.isPresent(a,items))}return items},and:function(){for(var items=this,i=0;i<arguments.length;++i){var a=arguments[i];items="function"==typeof a?a.call(items):rql.ops.isPresent(a,items)}return items},select:function(){var args=arguments,argc=arguments.length,res=this.map(function(object){for(var selected={},i=0;argc>i;i++){var propertyName=args[i],value=evaluateProperty(object,propertyName);"undefined"!=typeof value&&(selected[propertyName]=value)}return selected});return res},unselect:function(){var args=arguments,argc=arguments.length;return this.map(function(object){var selected={};for(var i in object)object.hasOwnProperty(i)&&(selected[i]=object[i]);for(var i=0;argc>i;i++)delete selected[args[i]];return selected})},values:function(first){if(1==arguments.length)return this.map(function(object){return retrieve(object,first)});var args=arguments,argc=arguments.length;return this.map(function(object){var realObject=retrieve(object),selected=[];if(0===argc)for(var i in realObject)realObject.hasOwnProperty(i)&&selected.push(realObject[i]);else for(var i=0;argc>i;i++){var propertyName=args[i];selected.push(realObject[propertyName])}return selected})},limit:function(limit,start,maxCount){var totalCount=this.length;start=start||0;var sliced=this.slice(start,start+limit);return maxCount&&(sliced.start=start,sliced.end=start+sliced.length-1,sliced.totalCount=Math.min(totalCount,"number"==typeof maxCount?maxCount:1/0)),sliced},distinct:function(){var primitives={},needCleaning=[],newResults=this.filter(function(value){return value=retrieve(value),value&&"object"==typeof value?value.__found__?!1:(value.__found__=function(){},needCleaning.push(value),!0):primitives[value]?!1:(primitives[value]=!0,!0)});return needCleaning.forEach(function(object){delete object.__found__}),newResults},recurse:function(property){function recurse(value){if(value.forEach)value.forEach(recurse);else if(newResults.push(value),property)value=value[property],value&&"object"==typeof value&&recurse(value);else for(var i in value)value[i]&&"object"==typeof value[i]&&recurse(value[i])}var newResults=[];return recurse(retrieve(this)),newResults},aggregate:function(){for(var distinctives=[],aggregates=[],i=0;i<arguments.length;i++){var arg=arguments[i];"function"==typeof arg?aggregates.push(arg):distinctives.push(arg)}var distinctObjects={},dl=distinctives.length;this.forEach(function(object){object=retrieve(object);for(var key="",i=0;dl>i;i++)key+="/"+object[distinctives[i]];var arrayForKey=distinctObjects[key];arrayForKey||(arrayForKey=distinctObjects[key]=[]),arrayForKey.push(object)});var al=aggregates.length,newResults=[];for(var key in distinctObjects){for(var arrayForKey=distinctObjects[key],newObject={},i=0;dl>i;i++){var property=distinctives[i];newObject[property]=arrayForKey[0][property]}for(var i=0;al>i;i++){var aggregate=aggregates[i];newObject[i]=aggregate.call(arrayForKey)}newResults.push(newObject)}return newResults},between:filter(function(value,range){return value=retrieve(value),value>=range[0]&&value<range[1]}),sum:reducer(function(a,b){return a=retrieve(a),b=retrieve(b),a+b}),mean:function(property){return rql.ops.sum.call(this,property)/this.length},max:reducer(function(a,b){return a=retrieve(a),b=retrieve(b),Math.max(a,b)}),min:reducer(function(a,b){return a=retrieve(a),b=retrieve(b),Math.min(a,b)}),count:function(){return this.length},first:function(){return this[0]},last:function(){return this[this.length-1]},random:function(){return this[Math.round(Math.random()*(this.length-1))]},one:function(){if(this.length>1)throw new Error("RQLError : More than one object found");return this[0]}},owalk.rql=rql,module.exports=owalk},{"../index":2,"rql/parser":6}],6:[function(require,module,exports){({define:"undefined"!=typeof define?define:function(deps,factory){module.exports=factory(exports,require("./util/contains"))}}).define(["exports","./util/contains"],function(exports,contains){function parse(query,parameters){function call(newTerm){term.args.push(newTerm),term=newTerm,contains(exports.lastSeen,term.name)&&(topTerm.cache[term.name]=term.args)}function setConjunction(operator){if(term.name){if(term.name!==operator)throw new Error("Can not mix conjunctions within a group, use paranthesis around each set of same conjuctions (& and |)")}else term.name=operator}function removeParentProperty(obj){if(obj&&obj.args){delete obj.parent;for(var args=obj.args,i=0,l=args.length;l>i;i++)removeParentProperty(args[i])}return obj}("undefined"==typeof query||null===query)&&(query="");var term=new exports.Query,topTerm=term;if(topTerm.cache={},"object"==typeof query){if(query instanceof exports.Query)return query;for(var i in query){var term=new exports.Query;topTerm.args.push(term),term.name="eq",term.args=[i,query[i]]}return topTerm}if("?"==query.charAt(0))throw new URIError("Query must not start with ?");exports.jsonQueryCompatible&&(query=query.replace(/%3C=/g,"=le=").replace(/%3E=/g,"=ge=").replace(/%3C/g,"=lt=").replace(/%3E/g,"=gt=")),query.indexOf("/")>-1&&(query=query.replace(/[\+\*\$\-:\w%\._]*\/[\+\*\$\-:\w%\._\/]*/g,function(slashed){return"("+slashed.replace(/\//g,",")+")"})),query=query.replace(/(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)([<>!]?=(?:[\w]*=)?|>|<)(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)/g,function(t,property,operator,value){if(operator.length<3){if(!operatorMap[operator])throw new URIError("Illegal operator "+operator);operator=operatorMap[operator]}else operator=operator.substring(1,operator.length-1);return operator+"("+property+","+value+")"}),"?"==query.charAt(0)&&(query=query.substring(1));var leftoverCharacters=query.replace(/(\))|([&\|,])?([\+\*\$\-:\w%\._]*)(\(?)/g,function(t,closedParan,delim,propertyOrValue,openParan){if(delim&&("&"===delim&&setConjunction("and"),"|"===delim&&setConjunction("or")),openParan){var newTerm=new exports.Query;newTerm.name=propertyOrValue,newTerm.parent=term,call(newTerm)}else if(closedParan){var isArray=!term.name;if(term=term.parent,!term)throw new URIError("Closing paranthesis without an opening paranthesis");isArray&&term.args.push(term.args.pop().args)}else if((propertyOrValue||","===delim)&&(term.args.push(stringToValue(propertyOrValue,parameters)),contains(exports.lastSeen,term.name)&&(topTerm.cache[term.name]=term.args),"eq"===term.name&&term.args[0]===exports.primaryKeyName)){var id=term.args[1];!id||id instanceof RegExp||(id=id.toString()),topTerm.cache[exports.primaryKeyName]=id}return""});if(term.parent)throw new URIError("Opening paranthesis without a closing paranthesis");if(leftoverCharacters)throw new URIError("Illegal character in query string encountered "+leftoverCharacters);return removeParentProperty(topTerm),topTerm}function stringToValue(string,parameters){var converter=exports.converters["default"];if("$"===string.charAt(0)){var param_index=parseInt(string.substring(1))-1;return param_index>=0&&parameters?parameters[param_index]:void 0}if(string.indexOf(":")>-1){var parts=string.split(":",2);if(converter=exports.converters[parts[0]],!converter)throw new URIError("Unknown converter "+parts[0]);string=parts[1]}return converter(string)}var operatorMap={"=":"eq","==":"eq",">":"gt",">=":"ge","<":"lt","<=":"le","!=":"ne"};exports.primaryKeyName="id",exports.lastSeen=["sort","select","values","limit"],exports.jsonQueryCompatible=!0,exports.parse=exports.parseQuery=parse,exports.parseGently=function(){var terms;try{terms=parse.apply(this,arguments)}catch(err){terms=new exports.Query,terms.error=err.message}return terms},exports.commonOperatorMap={and:"&",or:"|",eq:"=",ne:"!=",le:"<=",ge:">=",lt:"<",gt:">"};var autoConverted=exports.autoConverted={"true":!0,"false":!1,"null":null,undefined:void 0,Infinity:1/0,"-Infinity":-(1/0)};return exports.converters={auto:function(string){if(autoConverted.hasOwnProperty(string))return autoConverted[string];var number=+string;return isNaN(number)||number.toString()!==string?(string=decodeURIComponent(string),exports.jsonQueryCompatible&&"'"==string.charAt(0)&&"'"==string.charAt(string.length-1)?JSON.parse('"'+string.substring(1,string.length-1)+'"'):string):number},number:function(x){var number=+x;if(isNaN(number))throw new URIError("Invalid number "+number);return number},epoch:function(x){var date=new Date(+x);if(isNaN(date.getTime()))throw new URIError("Invalid date "+x);return date},isodate:function(x){var date="0000".substr(0,4-x.length)+x;return date+="0000-01-01T00:00:00Z".substring(date.length),exports.converters.date(date)},date:function(x){var isoDate=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(x);if(isoDate?date=new Date(Date.UTC(+isoDate[1],+isoDate[2]-1,+isoDate[3],+isoDate[4],+isoDate[5],+isoDate[6])):date=new Date(x),isNaN(date.getTime()))throw new URIError("Invalid date "+x);return date},"boolean":function(x){return"true"===x},string:function(string){return decodeURIComponent(string)},re:function(x){return new RegExp(decodeURIComponent(x),"i")},RE:function(x){return new RegExp(decodeURIComponent(x))},glob:function(x){var s=decodeURIComponent(x).replace(/([\\|\||\(|\)|\[|\{|\^|\$|\*|\+|\?|\.|\<|\>])/g,function(x){return"\\"+x}).replace(/\\\*/g,".*").replace(/\\\?/g,".?");return s=".*"!==s.substring(0,2)?"^"+s:s.substring(2),".*"!==s.substring(s.length-2)?s+="$":s=s.substring(0,s.length-2),new RegExp(s,"i")}},exports.converters["default"]=exports.converters.auto,exports.Query=function(){this.name="and",this.args=[]},exports})},{"./util/contains":7}],7:[function(require,module,exports){({define:"undefined"!=typeof define?define:function(deps,factory){module.exports=factory(exports)}}).define([],function(){function contains(array,item){for(var i=0,l=array.length;l>i;i++)if(array[i]===item)return!0}return contains})},{}]},{},[1])(1)});